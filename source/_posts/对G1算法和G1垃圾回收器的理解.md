---
title: 对G1算法和G1垃圾回收器的理解
date: 2019-01-06 17:09:39
categories: 
	- JVM
---

G1(Garbage-First )垃圾回收算法，HotspotVM的四种GC算法之一。
G1垃圾回收器启动参数-XX:+UseG1GC，Java 9开始被作为默认垃圾回收器。
这里基于读者已经了解其他三种GC算法，我作为一个blog搬运工(关于G1算法的优秀blog看参考资料)，谈一下对G1算法的理解思路。

G1算法是完全独立于HotspotVM其他GC算法的。先引用一下R大对G1算法的解释。

> **RednaxelaFX**:
> 
> 从最高层看，G1的collector一侧其实就是两个大部分： 
> 
>* 全局并发标记（global concurrent marking） 
>
>* 拷贝存活对象（evacuation） 
>
>而这两部分可以相对独立的执行。 

把G1分成**global concurrent marking**和**evacuation**的理解更友好。其他的思路我也看过，将GC分为四个阶段，最后一个阶段是筛选回收，这种理解方法并不好，因为真正回收内存的操作并不一定是紧接着在完成所有标记之后。《深入理解Java虚拟机:JVM高级特性与最佳实践(第2版)》讲的G1收集器并不清楚，但作为入门JVM确实是本好书。

global concurrent marking 基于SATB

1. 初始标记（initial marking）暂停阶段
从GC Roots开始直接可达的对象。在G1垃圾回收器中还会存在young GC，这个阶段借用了young GC的暂停

2. 并发标记（concurrent marking）并发阶段
从GC Roots开始对堆中的对象标记，标记线程与应用程序线程并行执行，这个过程基于SATB。还会伴随着扫描SATB write barrier记录的引用变化

3. 最终标记（final marking / remarking）暂停阶段
处理还未扫描完的SATB write barrier。CMS的remark阶段扫描的是INC write barrier，由于这个无法发现 Concurrent Mark 期间堆外根集（寄存器、栈）的引用变化，所以CMS的remark阶段可能会很慢。(具体区别请看[[HotSpot VM] 关于incremental update与SATB的一点理解](https://link.zhihu.com/?target=http%3A//hllvm.group.iteye.com/group/topic/44529))

4. 筛选回收（cleanup）暂停阶段
统计各个region中存活对象

evacuation 全暂停





参考资料：
---

- [[HotSpot VM] 请教G1算法的原理](https://hllvm-group.iteye.com/group/topic/44381#post-272188)
- [[HotSpot VM] 关于incremental update与SATB的一点理解](https://link.zhihu.com/?target=http%3A//hllvm.group.iteye.com/group/topic/44529)
- [可能是最全面的G1学习笔记 - 阿杜的世界](https://cloud.tencent.com/developer/article/1378263)
- [Java Hotspot G1 GC的一些关键技术 - 美团技术团队](https://tech.meituan.com/g1.html)
